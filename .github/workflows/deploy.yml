name: CI/CD Backend - Testes e Deploy no Render

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'  # Só executa se houver mudanças no backend
  pull_request:
    branches:
      - main
    paths:
      - 'server/**'

jobs:
  # Job 1: Executar testes
  test:
    name: Executar Testes Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Instalar dependências
        working-directory: ./server
        run: npm ci
      
      - name: Executar testes
        working-directory: ./server
        run: npm run test:ci
        env:
          NODE_ENV: test

  # Job 2: Deploy (só executa se testes passarem)
  deploy:
    name: Deploy Backend no Render
    runs-on: ubuntu-latest
    needs: test  # Só executa se o job 'test' for bem-sucedido
    if: github.ref == 'refs/heads/main'  # Só faz deploy da branch main
    
    steps:
      - name: Disparar deploy no Render
        run: |
          echo "Iniciando deploy no Render..."
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
          echo "Deploy disparado com sucesso!"
